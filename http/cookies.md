# Cookies
By default PSR 7 does not separate cookie headers from any other `Response` header, this may create some problems while trying to work with cookies in efficient way. Hovewer spiral provides simplied ways to manipulate with response cookies using CookieManager middleware.

## Set-Cookie Header
To set cookie directly in response we can use default `Reponse->withAddedHeader()` construction with cookie header generated by `CookieManager`, in this case no encryption will be applied to cookie and data will be treated as simple header.

```php
public function action()
{
	return new Reponse('', 200, array(
		'Set-Cookie'=> [
			$this->cookies->create('name', 'value', 3600)
		]
	));
}
```

```php
public function filter(Response $response)
{
	return $reponse->withAddedHeader(
		'Set-Cookie',
		$this->cookies->create('name', 'value')
	);
}
```
`CookieManager` create method will create valid cookie header using values provided in a same order as for `setcookie` method.

> CookieManager uses lifetime value instead of expiration, this means that you don't need to provide absolute timestamp.


## Using Cookie header class
Another option to create cookie header is using Cookie class, this class provides lights abstraction at top of Set-Cookier header.

``` php
return $reponse->withAddedHeader(
		'Set-Cookie',
		Cookie::create('name','value')->packHeader()
	);
```

## Using Middleware
Another option uses `CookieManager` middleware to scheldule cookie to be sent right before Request will be dispatched. In this case our code can be simplified a lot and we don't need Request instance anymore.

```php
public function action()
{
	$this->cookies->set("name", "value", 3600);
	...
}
```

One of the benefins about using this method that all cookie header values will be passed though selected protection method (HMAC or encryption).

To get all schelduled cookies execute:

```php
$this->cookies->getScheldules();
```

Method will return array of `Cookie` instances, for example:

```php
public function listCookies(CookieManager $cookies)
{
	foreach($cookies->getSchelduled() as $cookie)
	{
		dump($cookie->getName());
	}
}
```

> Attention, CookieManager can not be used to read incoming cookies, use `InputManager` or active `ServerRequestInstance` for this purposes.

Additionally to cookie creation CookieManager will mount attribute value to active request `cookieDomain` which will contain pre-configured domain to be used for cookie.

## Selecting protection method
`CookieManager` middleware provides 2 different ways to protect cookie data.

> This still doesn't mean you should use cookies to store sensitive data. :)

### HMAC
HMAC will sign every sent cookie with hash code to ensure that cookie wasn't altered on client side. This method is fairly fast but user able to view cookie content.

To enable HMAC method change method value in your http config to "hmac".

```php
	...
	'cookies' => array(
		'domain' => '{host}',
		'path'   => '/',
		'method' => 'hmac'
	)
```

Incoming cookies with invalid hash or modified content will still be presented in request but with `null` value.

### Encryption
Encryption will encode all cookie values using `Encrypter` component, this will make content unreadable and non editable by client. Default encrypter key will be used.

To enabled cookie encrypting, modify your http config:

```php
	...
	'cookies' => array(
		'domain' => '{host}',
		'path'   => '/',
		'method' => 'encrypt'
	)
```

Incoming cookies with invalid encryption will be still presented in request with `null` value.

### Disable protection
In cases when you need extra bit of performance you can disable cookie protection entirelly, in this case cookie content will be sent to client un-altered and no input validation will be performed.

To disabled cookie protection modify your http config:

```php
	...
	'cookies' => array(
		'domain' => '{host}',
		'path'   => '/',
		'method' => 'none'
	)
```

### Disable protection for specified cookies
In some cases you may want to encrypt or sign most of your cookies but exclude some specified set (usually token based values like csrf and session tokens). To exclude cookie from encoding and decoging use `exclude` method.

```php
public function bootstrap()
{
	$this->cookies->exclude('myToken');
}
```

> Attention, this method should be executed **before** starting `HttpDispatcher`.

## Configuring default cookies domain
Default `domain` value are presented in http config and can be edited at any moment.

Hovewer, domain value provided in pattern form and can provide additional functionality:

```php
...
	'cookies' => array(
		'domain' => '{host}',
		'method' => 'none'
	)
```

Using provided config default cookie domain value will be calculated using current host (`{host}` string) value provided by HttpDispatched. We can modify this configuration to set cookie for domain and all sub domains.

```php
...
	'cookies' => array(
		'domain' => '.{host}',
		'method' => 'none'
	)
```

> Spiral will ignore this pattern if website launched using ip address.

Additionally you can manually force domain:

```php
...
	'cookies' => array(
		'domain' => 'mydomain.com',
		'method' => 'none'
	)
```
You can always get currently configured and compiled domain value using `cookieDomain` attribute of active request.