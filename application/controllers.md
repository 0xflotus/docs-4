# Controllers
Controllers as it stated in their name are responsinble for controlling application flow, they usually can access user request, different models (services) and provide content to be sent to client using JSON arrays or view component. Basic controller example may look like (default controller action is 'index'):

```php
class HomeController extends Controller
{
    /**
     * Index method.
     */
    public function index()
    {
        return 'hello world';
    }
}
```

> Output generated by controllers usually send directly to MiddlewarePipeline which will wrap it into a valid response, meaning you can return strings and arrays from
your controllers.

## Dependency Injection
Controllers with definitely need some extrernal classes like views, services and etc to operate. Due every `Controller` is instance of `Service` you can use `init`
method and short bindings for core components.

```php
class HomeController extends Controller
{
    /**
     * @var UserService
     */
    protected $users = null;

    /**
     * @param UserService $users
     */
    public function init(UserService $users)
    {
        $this->users = $users;
    }

    /**
     * Index method.
     */
    public function index()
    {
        return $this->views->render('users', [
            'users' => $this->users->find()
        ]);
    }
}
```

In addition to that, every controller provides support for method injection, which allows you to request needed dependencies in action specifically:
```php
class HomeController extends Controller
{
    /**
     * Index method.
     */
    public function index(UserService $users)
    {
        return $this->views->render('users', [
            'users' => $users->find()
        ]);
    }
}
```

## Call Controller Action
You can execute any needed controller at any moment using Core method `callAction`, this method only requires controller class, action name (can be empty) and set
of parameters to pass into controller action (such parameters will be combined with method dependencies).

```php
class HomeController extends Controller
{
    /**
     * Index method.
     */
    public function index(UserService $users)
    {
        dump($this->core->callAction(DataController::class, 'action', [
            'id' => 'someid'
        ]);
    }
}
```

> Http routes can declare some parts of Uri to be passed to controller as parameters, that's exacly why you can use `id` parameter in controllers routed by 
default route.

If controller action missing parameter(s), or method does not exsists - `ControllerException` will be thrown.

> You can also request outer controller as dependency, hovewer RBAC controllers require their actions to be called using method `callAction`, in other scenario you will bypass permissions control layer. 

## Scaffolding
You can generate needed controllers using `create:controller name` command. While generation you can specify services controller depends on, pre-generate some methods or even link controller to existed data entity service which will generate set of methods to retrieve, save and delete entities. Let's use our `UserService` from previous section - `create:controller users -s user`:

```php
class UsersController extends Controller
{
    /**
     * @var string
     */
    protected $defaultAction = 'retrieve';

    /**
     * @var UserService
     */
    protected $users = null;

    /**
     * @param UserService $users
     */
    public function init(UserService $users)
    {
        $this->users = $users;
    }

    /**
     * Retrieve all entities selected from Services\UserService and render them using view
     * 'users/list'.
     *
     * @return string
     */
    public function retrieve()
    {
        return $this->views->render('users/list', [
            'list' => $this->users->find()->paginate(50)
        ]);
    }

    /**
     * Fetch one entity from Services\UserService and render it using view 'users/show'.
     *
     * @param string $id
     * @return string
     */
    public function show($id)
    {
        if (empty($entity = $this->users->findByPK($id))) {
            throw new ClientException(ClientException::NOT_FOUND);
        }

        return $this->views->render('users/show', compact('entity'));
    }

    /**
     * Create new entity using view 'users/create'.
     *
     * @return string
     */
    public function create()
    {
        return $this->views->render('users/create', ['entity' => $this->users->create()]);
    }

    /**
     * Edit existed entity form using view 'users/edit'.
     *
     * @param string $id
     * @return string
     */
    public function edit($id)
    {
        if (empty($entity = $this->users->findByPK($id))) {
            throw new ClientException(ClientException::NOT_FOUND);
        }

        return $this->views->render('users/edit', compact('entity'));
    }

    /**
     * Update existed or create new entity using Services\UserService. JSON will be returned.
     *
     * @param string $id
     * @return array
     */
    public function save($id = null)
    {
        if (!empty($id)) {
            $entity = $this->users->findByPK($id);
            if (empty($entity)) {
                throw new ClientException(ClientException::NOT_FOUND);
            }
        } else {
            $entity = $this->users->create();
        }

        //Use true as second parameter to bypass non fillable flag
        $entity->setFields($this->input->data);
        if (!$this->users->save($entity, true, $errors)) {
            return [
                'status' => ClientException::BAD_DATA,
                'errors' => $errors
            ];
        }

        if (empty($id)) {
            return [
                'status'  => 201,
                'message' => 'Created, redirecting...',
                'action'  => [
                    'delay'    => 2000,
                    'redirect' => (string)$this->router->createUri(
                        'users::edit', ['id' => (string)$entity->primaryKey()]
                    )
                ]
            ];
        }

        return ['status' => 200, 'message' => 'Updated'];
    }

    /**
     * Delete one entity using it's primary key and service Services\UserService. JSON will be
     * returned.
     *
     * @param string $id
     * @return array
     */
    public function delete($id)
    {
        if (empty($entity = $this->users->findByPK($id))) {
            throw new ClientException(ClientException::NOT_FOUND);
        }

        if (!$this->users->delete($entity)) {
            throw new ClientException(ClientException::ERROR);
        }

        return ['status' => 200, 'message' => 'Deleted'];
    }
}
```

## Routing
Every controller located in `application/classes/Controllers` directory (not sub directories) will be handled by default http route which looks like "/controller/action/id" (where `action` and `id` are optional). You can read more about default and custom routes in [Routing section](/http/routing.md) of `HttpDispatcher`.
